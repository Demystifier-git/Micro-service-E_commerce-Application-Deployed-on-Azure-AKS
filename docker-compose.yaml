version: "3.8"

services:

  mongodb:
    build:
      context: ./mongo
      dockerfile: Dockerfile
    image: mongo:8.0
    networks:
      - robotnetwork
    logging: &json-logging
      driver: json-file
      options:
        max-size: "25m"
        max-file: "2"
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      retries: 5
      timeout: 5s

  mysql:
    build:
      context: ./mysql
      dockerfile: Dockerfile
    image: mysql:8.0
    env_file:
      - ./sql_env/.env
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql/scripts/20-ratings.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - robotnetwork
    logging:
      <<: *json-logging
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "mysql"]
      interval: 10s
      retries: 5
      timeout: 5s

  redis:
    image: redis:6.2-alpine
    networks:
      - robotnetwork
    logging:
      <<: *json-logging
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      retries: 5
      timeout: 5s

  rabbitmq:
    image: rabbitmq:3.8-management-alpine
    networks:
      - robotnetwork
    logging:
      <<: *json-logging
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      retries: 5
      timeout: 5s

  cart:
    build:
      context: ./cart
      dockerfile: Dockerfile
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - robotnetwork
    logging:
      <<: *json-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      retries: 5
      timeout: 5s

  ratings:
    build:
      context: ./ratings
      dockerfile: Dockerfile
    env_file:
      - ./php/.env
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - robotnetwork
    logging:
      <<: *json-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      retries: 5
      timeout: 5s

  payment:
    build:
      context: ./payment
      dockerfile: Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - robotnetwork
    logging:
      <<: *json-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      retries: 5
      timeout: 5s

  dispatch:
    build:
      context: ./dispatch
      dockerfile: Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - robotnetwork
    logging:
      <<: *json-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      retries: 5
      timeout: 5s

  shipping:
    build:
      context: ./shipping
      dockerfile: Dockerfile
    networks:
      - robotnetwork
    logging:
      <<: *json-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      retries: 5
      timeout: 5s  

  user:
    build:
      context: ./user
      dockerfile: Dockerfile
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - robotnetwork
    logging:
      <<: *json-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      retries: 5
      timeout: 5s  

  catalogue:
    build:
      context: ./catalogue
      dockerfile: Dockerfile
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - robotnetwork
    logging:
      <<: *json-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      retries: 5
      timeout: 5s        

  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    depends_on:
      catalogue:
        condition: service_healthy
      user:
        condition: service_healthy
      shipping:
        condition: service_healthy
      payment:
        condition: service_healthy
    ports:
      - "8080:8080"
    networks:
      - robotnetwork
    logging:
      <<: *json-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 10s
      retries: 5
      timeout: 5s

networks:
  robotnetwork:
    driver: bridge

volumes:
  mysql-data:




